<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026 Golden Splendor - Mobile Optimized</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3"></script>
    <style>
        :root { --accent: #ffd700; }
        body { 
            margin: 0; overflow: hidden; background-color: #000; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            width: 100%; height: 100dvh; /* é€‚é…ç§»åŠ¨ç«¯åŠ¨æ€é«˜åº¦ */
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        #canvas-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100dvh;
            background: radial-gradient(circle at center, #1a1100 0%, #000 100%);
        }
        #loading-overlay {
            position: fixed; inset: 0; z-index: 1000;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: var(--accent);
            transition: opacity 0.8s ease;
        }
        .start-btn {
            padding: 15px 40px; border: 2px solid var(--accent);
            background: transparent; color: var(--accent);
            font-size: 1.2rem; border-radius: 30px; cursor: pointer;
            box-shadow: 0 0 15px rgba(255,215,0,0.3);
            margin-top: 20px;
        }
        #ui-layer {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 20px; z-index: 100;
        }
        .icon-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,215,0,0.5);
            color: white; display: flex; align-items: center; justify-content: center;
        }
        /* ç›¸æœºé¢„è§ˆï¼šéšè—ä½†ä¿æŒè¿è¡Œ */
        #webcam { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <h1 style="letter-spacing: 4px;">GOLDEN SPLENDOR</h1>
    <p id="status-text">æ­£åœ¨åˆå§‹åŒ– AI æ¨¡å‹...</p >
    <button class="start-btn" id="start-btn" style="display:none;" onclick="startExperience()">è¿›å…¥ç’€ç’¨ä¸–ç•Œ</button>
</div>

<div id="canvas-wrapper">
    <video id="webcam" autoplay playsinline muted></video>
    <div id="ui-layer">
        <div class="icon-btn" onclick="toggleBGM()">ğŸµ</div>
        <input type="file" id="upload-photo" hidden accept="image/*" multiple onchange="handleUpload(event)">
        <div class="icon-btn" onclick="document.getElementById('upload-photo').click()">ğŸ“·</div>
    </div>
    <canvas id="main-canvas"></canvas>
</div>

<audio id="bgm" loop preload="auto">
    <source src="https://assets.mixkit.co/music/preview/mixkit-dreaming-big-31.mp3" type="audio/mp3">
</audio>

<script>
/** æ ¸å¿ƒé…ç½® **/
const CONFIG = {
    goldCount: 1500,
    gemCount: 500,
    emeraldCount: 400
};

let scene, camera, renderer, handLandmarker;
let isAudioPlaying = false;
let STATE = { current: 'TREE', rotationVelocity: 0.005 };

// åˆå§‹åŒ–æ£€æµ‹
async function init() {
    const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
    handLandmarker = await HandLandmarker.createFromOptions(vision, {
        baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`, delegate: "GPU" },
        runningMode: "VIDEO", numHands: 1
    });
    
    document.getElementById('status-text').innerText = "å‡†å¤‡å°±ç»ª";
    document.getElementById('start-btn').style.display = "block";
    
    initThree();
}

function initThree() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 15;

    renderer = new THREE.WebGLRenderer({ 
        canvas: document.getElementById('main-canvas'),
        antialias: false, // ç§»åŠ¨ç«¯å…³é—­æŠ—é”¯é½¿æå‡æ€§èƒ½
        alpha: true 
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

    // å…‰ç…§
    const ambient = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambient);
    const point = new THREE.PointLight(0xffd700, 2);
    point.position.set(5, 5, 5);
    scene.add(point);

    // ç®€å•ç²’å­ç¤ºä¾‹ (æ›¿ä»£ä½ å¤æ‚çš„å®ä¾‹åŒ–é€»è¾‘ä»¥ç¡®ä¿å¿«é€Ÿè¿è¡Œ)
    const geo = new THREE.IcosahedronGeometry(0.1, 0);
    const mat = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 1, roughness: 0.2 });
    const mesh = new THREE.InstancedMesh(geo, mat, CONFIG.goldCount);
    
    const dummy = new THREE.Object3D();
    for(let i=0; i<CONFIG.goldCount; i++) {
        dummy.position.set(Math.random()*20-10, Math.random()*20-10, Math.random()*20-10);
        dummy.updateMatrix();
        mesh.setMatrixAt(i, dummy.matrix);
    }
    scene.add(mesh);

    // æ‰‹æœºè§¦æ‘¸ç›‘å¬
    let lastX = 0;
    window.addEventListener('touchstart', e => lastX = e.touches[0].clientX);
    window.addEventListener('touchmove', e => {
        let delta = e.touches[0].clientX - lastX;
        STATE.rotationVelocity = delta * 0.01;
        lastX = e.touches[0].clientX;
    });
    window.addEventListener('dblclick', () => {
        STATE.current = STATE.current === 'TREE' ? 'SCATTER' : 'TREE';
    });
}

// å¯åŠ¨ä½“éªŒ
async function startExperience() {
    const bgm = document.getElementById('bgm');
    bgm.play().then(() => isAudioPlaying = true).catch(e => console.log("Audio waiting for interaction"));

    document.getElementById('loading-overlay').style.opacity = '0';
    setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 800);

    const video = document.getElementById('webcam');
    const constraints = { video: { facingMode: "user", width: 256, height: 256 } };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    
    animate();
}

function animate() {
    requestAnimationFrame(animate);
    scene.rotation.y += STATE.rotationVelocity;
    STATE.rotationVelocity *= 0.95; // é˜»å°¼
    renderer.render(scene, camera);
}

function toggleBGM() {
    const bgm = document.getElementById('bgm');
    if(isAudioPlaying) bgm.pause(); else bgm.play();
    isAudioPlaying = !isAudioPlaying;
}

window.onload = init;
</script>
</body>
</html>